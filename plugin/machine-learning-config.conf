# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Copyright (c) 2021-2022 Core Rule Set project. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: machine-learning
# Plugin description: Memory-safe ML integration for SQL Injection detection
# Rule ID block base: 9,516,000 - 9,516,999
# Plugin version: 1.0.0

# Documentation can be found here:
# https://github.com/coreruleset/machine-learning-integration-plugin

# Set resource limits to prevent memory issues
SecRequestBodyLimit 1048576
SecRequestBodyInMemoryLimit 524288
SecRequestBodyNoFilesLimit 524288
SecResponseBodyLimit 1048576

# Enable plugin with memory-safe defaults
SecAction \
  "id:9516000,\
   phase:1,\
   pass,\
   nolog,\
   setvar:tx.machine-learning-plugin_enabled=1,\
   setvar:tx.machine-learning-plugin_max_args=100,\
   setvar:tx.machine-learning-plugin_max_arg_length=1024"

# Set ML server configuration with timeouts
SecAction \
  "id:9516001,\
   phase:1,\
   pass,\
   nolog,\
   setvar:tx.ml_server_url=http://localhost:5000/,\
   setvar:tx.ml_timeout=1000,\
   setvar:tx.ml_fail_open=1,\
   setvar:tx.ml_max_retries=2"

# Initialize ML score variables
SecAction \
  "id:9516002,\
   phase:1,\
   pass,\
   nolog,\
   setvar:tx.ml_score=0,\
   setvar:tx.ml_threshold=-0.5"

# Process requests in chunks to prevent memory issues
SecRule REQUEST_HEADERS:Content-Length "!@rx ^[0-9]{1,7}$" \
  "id:9516050,\
   phase:1,\
   deny,\
   status:413,\
   log,\
   msg:'Invalid Content-Length header'"

# Rate limiting for ML requests
SecAction \
  "id:9516051,\
   phase:1,\
   pass,\
   nolog,\
   setvar:ip.ml_requests=+1,\
   expirevar:ip.ml_requests=60"

SecRule IP:ML_REQUESTS "@gt 100" \
  "id:9516052,\
   phase:1,\
   deny,\
   status:429,\
   log,\
   msg:'ML request rate limit exceeded'"

# Call ML prediction with memory limits
SecRule REQUEST_FILENAME|ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES "@rx ." \
  "id:9516100,\
   phase:2,\
   pass,\
   t:none,\
   nolog,\
   chain"
    SecRule ARGS_NAMES "@lt %{tx.machine-learning-plugin_max_args}" \
      "chain"
        SecRule ARGS "@validateByteRange 1-255" \
          "id:9516101,\
           phase:2,\
           t:none,\
           exec:/etc/modsecurity/lua/machine-learning-client.lua"

# Block if ML score indicates attack
SecRule TX:ml_score "@lt %{tx.ml_threshold}" \
  "id:9516200,\
   phase:2,\
   deny,\
   status:403,\
   log,\
   msg:'Potential SQL Injection detected by ML model',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'platform-multi',\
   tag:'attack-sqli',\
   tag:'ML-SCORE-%{tx.ml_score}',\
   severity:'CRITICAL'"

# Health check for ML server
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1" \
  "id:9516300,\
   phase:1,\
   pass,\
   nolog,\
   ctl:ruleEngine=Off"

# Fail open on ML server errors
SecRule TX:ml_fail_open "@eq 1" \
  "id:9516400,\
   phase:2,\
   pass,\
   nolog,\
   skipAfter:END_ML_RULES"

# Memory cleanup
SecAction \
  "id:9516500,\
   phase:5,\
   pass,\
   nolog,\
   setvar:tx.machine-learning-plugin_enabled=0,\
   setvar:tx.ml_score=0"

SecMarker END_ML_RULES
