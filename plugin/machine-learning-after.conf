# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Plugin name: machine-learning-integration
# ------------------------------------------------------------------------

# Initialize ML variables
SecAction \
    "id:9666101,\
    phase:1,\
    pass,\
    nolog,\
    setvar:tx.ml_enabled=1"

# Process request if ML is enabled
SecRule TX:ML_ENABLED "@eq 1" \
    "id:9666110,\
    phase:1,\
    pass,\
    nolog,\
    chain"
    SecRuleScript "/usr/share/modsecurity-crs/rules/machine-learning-client.lua"

# Block if ML detects attack
SecRule TX:ML_IS_ATTACK "@eq 1" \
    "id:9666120,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection Attack Detected by ML',\
    logdata:'Attack Score: %{TX.ML_ATTACK_PROBABILITY}',\
    severity:'CRITICAL'"

SecMarker "END_ML_CHECK"
